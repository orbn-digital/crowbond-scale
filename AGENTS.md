# Repository Guidelines

## Project Structure & Module Organization
- `src/`: TypeScript sources.
  - `config/`: env and runtime configuration.
  - `scales/`: device protocols (e.g., `XtremScale.ts`).
  - `services/`: orchestration and realtime (`ScaleManager.ts`, `realtime/*`).
  - `utils/`: logging, New Relic, helpers.
  - `index.ts`: application entry.
- `tests/`: Jest tests (`unit/`, `integration/`, `setup.ts`).
- `dist/`: compiled output (generated by `tsc`).
- `docs/`: product/ops docs (Ably/New Relic, mobile integration).

## Build, Test, and Development Commands
- `npm run start:dev`: Run locally with hot reload and `.env`.
- `npm run build`: Compile TypeScript to `dist/`.
- `npm run start`: Run compiled build with New Relic agent.
- `npm run start:prod`: Production start (NODE_ENV=production).
- `npm test` | `npm run test:watch` | `npm run test:coverage`: Jest tests.
- `npm run lint` | `lint:fix`: ESLint checks and autofix.
- `npm run format`: Prettier formatting for `src/` and `tests/`.
- `npm run pm2:start|stop|restart|logs`: Manage process via PM2.

## Coding Style & Naming Conventions
- TypeScript strict mode; Node >= 16.
- Prettier: 2‑space indent, semicolons, single quotes, 100‑col width.
- ESLint: explicit return types; no `any`; no floating promises; avoid `console` (warn/error only).
- File naming: classes in `PascalCase` (e.g., `ScaleManager.ts`), utilities lower‑case/camel (`logger.ts`).
- Paths: use `@/` alias for `src/` (see `tsconfig.json`).

## Testing Guidelines
- Framework: Jest + ts-jest; environment: Node.
- Location: `tests/unit` and `tests/integration`.
- Naming: `*.test.ts` or `*.spec.ts` under `src/` or `tests/`.
- Setup: shared config in `tests/setup.ts`.
- Coverage: generated to `coverage/`; use `npm run test:coverage` for PRs touching logic.

## Commit & Pull Request Guidelines
- Commits: follow Conventional Commits: `type(scope): summary`.
  - Types: `feat`, `fix`, `docs`, `chore`, `refactor`, `test`, `perf`, `build`, `ci`, `style`, `revert`.
  - Breaking: add `!` (e.g., `feat!: ...`) or footer `BREAKING CHANGE:`.
  - Examples:
    - `feat(realtime): add Ably reconnect jitter`
    - `fix(scales): handle UDP socket close race`
    - `test(manager): increase coverage for backoff`
- Reference issues in footer (e.g., `Refs #123`, `Closes #45`).
- PRs: clear description, rationale, testing notes, config impacts; link issues; include logs/output or screenshots for behavior changes.

## Security & Configuration
- Secrets via `.env` (see `.env.example`): `ABLY_API_KEY`, `NEW_RELIC_LICENSE_KEY`, scale IPs/ports.
- Do not commit `.env` or logs. Validate config with `npm run start:dev` and health endpoints.
- Monitor in production with PM2 and New Relic; use `pm2 logs` for incident triage.
